# Práctica 2: Tienda online con interacción Cliente - Servidor

Esta segunda práctica consiste en ampliar nuestra página web de forma que ahora acepte parámetros de formularios para realizar el **Login** y **comprar productos**. Además debe manejar **cookies** para guardar el estado de cada usuario y su **carrito de compra**. Por último también debe tener un **sistema de búsqueda con autocompletado**. Para ello he tenido que ampliar el código tanto el servidor web *back-end* como de la presentación al usuario *front-end*

En esta práctica, aparte de las especificaciones mínimas, he implementado un par de mejoras: la **identificación del usuario mediante su nombre y una password** y el **control del stock**.

Para ejecutar el servidor, basta con escribir en un terminal dentro de la carpeta P2 del directorio: 
> node tienda.js 
 
Posteriormente hay que entrar en el navegador web que se prefiera y poner la dirección:
> 127.0.0.1:9000

La práctica está optimizada en **Mozilla Firefox versión escritorio**, si se usa desde otro navegador o desde un dispositivo móvil puede que algunas fotos o letreros estén descuadrados.

## Documentación técnica del Servidor web

Voy a entrar directamente en detalle con las diferencias implementadas en esta práctica con respecto a la anterior:

**1. Base de datos**: he creado dos archivos JSON, uno llamado *tienda.json* en el que están los datos de la tienda por defecto que se arrancan cuando inicias el servidor web y el archivo *resultado.json* que es el archivo donde se guardan todos los cambios que se van realizando en la tienda, como el control de stock y la información de los pedidos.

**2. Login y Usuarios**: en la página principal de la tienda hay un hiperenlace que nos lleva a la página de **Login**, dentro aparece un formulario que debemos rellenar con un usuario y su contraseña. En esta versión de la tienda hay disponibles tres nombres de usuario y una contraseña que es la misma para los tres usuarios (todo ello definido en el fichero *tienda.json*). Cuando rellenas el formulario de Login, el servidor recorre el archivo json y verifica que el usuario introducido exista y su contraseña sea la correcta, en caso afirmativo se lanza una página de bienvenida y en caso contrario una página de error con información sobre como loguearse. Una vez logueado correctamente, se crea una cookie *user* cuyo valor es el nombre de usuario que hemos elegido, esta cookie sirve para hacer que dicho nombre aparezca escrito en lugar del enlace Login y a su vez será el utilizado cuando se realicen pedidos. Las distintas cookies se leen mediante funciones distintas según la cookie y sus datos son guardados en una variable que se devuelve para su posterior utilización.

   **2.5    Mejora de pedir una contraseña**: esta mejora la he implementado escribiendo en el fichero json un apartado "contraseña" para cada usuario, que puede ser modificada a mano, pero he dejado la misma para los tres usuarios de forma que sea más fácil hacer pruebas. La 
comprobación se hace con respecto a la contraseña de cada usuario en concreto. 

**3. Carrito de la compra**: dentro de la página de cada producto hay un icono de un carrito de la compra que te lleva a una página donde añadir productos. Dentro de esta página debemos escribir en un formulario la cantidad de productos de ese tipo que queremos añadir al carrito. En el momento que enviamos la información de ese formulario se nos devuelve una cookie con el tipo de producto que hemos añadido al carrito y otra cookie con la cantidad de ese producto que hemos seleccionado. En la versión que he hecho de la práctica sólo puede haber un producto en el carrito, de forma que si antes de finalizar la compra añades otro tipo de producto se eliminará el anterior y no podrás comprarlo. Una cosa que debo comentar con respecto a las cookies es que éstas están definidas con un path = "/" ya que yo tengo organizados mis recursos en diferentes carpetas y si no especifico un path, el navegador me asigna el path en el que se encuentra el formulario que rellenamos.

   **3.5 Mejora de control de stock**: esta mejora la he implementado en el momento que añadimos un producto al carrito. Esto es, cuando tú seleccionas la cantidad de productos que quieres comprar, el stock se resta del total que hay disponible, de forma que esos artículos quedan "reservados" para la persona que compra. El control se realiza leyendo la cantidad de stock que hay de cada producto del fichero *tienda.js*, si quieres añadir más unidades a tu carrito de los que hay disponibles en ese momento se te añadirá el máximo disponible. Por otro lado si has comprado todas las unidades y después quieres entrar a comprar más, saltará una página indicando que ya no quedan unidades de ese producto en concreto. Por último, una cosa que no he conseguido controlar es que si añades 3 unidades al carrito y sin finalizar la compra vuelves a entrar y añades 4 unidades más, éstas se sobreescribirán a las que había en tu carrito, no se van a sumar sus valores y no vas a tener 7 unidades en el carrito, así como el stock va a verse decrementado en 7 unidades puesto que no controlo que las unidades no compradas vuelvan al stock total.

**4. Procesamiento de la compra**: en la página principal hay un icono de un carrito que, pese a ser el mismo que hay en las páginas de los productos, nos lleva a un formulario distinto que es el de formalizar nuestra compra. Este formulario nos pide tanto la dirección de envío del pedido como el número de la tarjeta con el que queremos pagarlo, además de tener una línea dinámica donde se irá escribiendo si tenemos o no productos en nuestro carrito, el tipo de producto y la cantidad que vamos a comprar. Si le damos al botón de "Finalizar compra", tanto los datos introducidos como el nombre de usuario que estamos utilizando se añadirán al apartado "pedidos" del archivo *resultado.json*. No puedes finalizar la compra **si no te has logueado antes** con cualquiera de los usuarios, en ese caso saltará un mensaje indicando que no estás logueado junto con un link que te devuelve a la página principal.

**5. Búsqueda con autocompletado**: en la página principal, junto a las tres secciones de los productos hay un cuadro de búsqueda donde puedes teclear lo que quieras buscar. Funciona de la siguiente manera, debes escribir tres caracteres como mínimo para que comience la búsqueda, en ese momento se lanzará una petición AJAX por cada carácter introducido. Dicha petición toma como datos los caracteres que hayas escrito y se los envía a un programa Javascript que atiende la petición AJAX y comprueba que se ha realizado correctamente. Tras ello realiza una petición mediante 'GET' a mi servidor cuyo recurso es */resultados* y su parámetro es la cadena que hemos buscado. El servidor se encarga de encontrar todos los resultados que comienzan por dichos caracteres y mandarlos de vuelta al Javascript para que los muestre por pantalla en formato de lista deplegable con autocompletado. En ese momento nosotros podremos seleccionar del autocompletado uno de los productos disponibles y darle a la opción de buscar para ir a la página del producto o hacer lo mismo pero escribiendo totalmente el producto que queramos. Si escribimos algo que no se encuentra en mi tienda saltará una página de error y tendremos que darle al botón de retroceso en el navegador para volver a la página principal de la tienda.

## Documentación técnica del Front-end

La web que recibe el cliente y se muestra por pantalla se llama El Baúl del Coleccionista y está formado por un fichero html dinámico, que cambia el enlace al formulario de Login cuando detecta la cookie *user* por el nombre del usuario que contenía dicha cookie.

En la página principal podemos encontrar tres secciones, cada una con su foto correspondiente y su tipo determinado de producto. Además he incluido al lado de esos productos el cuadro de búsqueda con autocompletado. También hay un símbolo con un carrito para acceder a formalizar la compra y un footer en el lado inferior derecho con datos sobre mí y mi página de Github. Para acceder a las distintas secciones de la web simplemente hay que hacer click en la foto que las representa o en el híperenlace de la sección, también se puede acceder buscando en el cuadro de búsqueda un producto existente. La lista de productos existentes está situada en el fichero *tienda.json* y es leía al lanzar el servidor por primera vez. Cada una de las secciones accesibles está compuesta por una página html dinámica, con su correspondiente fichero css exclusivo que no se comparte entre ellas. La información que aparece y el precio de los productos son leídos según la página a la que estamos accediendo y se escribe su información en unos cuadros de forma dinámica. Su organización es en estructura de malla (*grid* en css) y su encuadre puede variar dependiendo del navegador desde el que se visualice. 

Las tres secciones incluyen una cantidad fija de 6 películas (que no representan todos los productos disponibles, pero lo he hecho así para no sobrecargarlas) junto con un rótulo que indica su nombre. Dentro de cada sección encontramos en el encabezado el icono del carrito, que ahora nos llevará a una página donde podemos añadir ese tipo de producto y su cantidad a la cesta. Junto al icono del carrito está el icono de una flecha que nos devolverá a la página anterior. 

También existe una página de error con una foto graciosa que aparece cuando el cliente pide un recurso que no existe en el sistema. Para llegar a ella simplemente hay que borrar parte del recurso pedido, de forma que queda un recurso que no existe, por ejemplo:

 > 127.0.0.1:9000/tiend

Aquí no voy a explicar el funcionamiento del código en sí, ya que eso viene bien explicado en los comentarios del mismo. Para saber  cualquier información adicional se puede recurrir a ellos.